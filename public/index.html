<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css" rel="stylesheet">
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/5.10.1/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/5.10.1/firebase-firestore.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <script defer src="https://unpkg.com/vue/dist/vue.js"></script>
  </head>
  <body>
    <div id="app">
      <div v-if="session">
        <div class="text-center">
          <button class="font-bold px-4 py-2 rounded border border-gray mx-4 my-2" type="button" @click="start()" :disabled="started_at != 0 || offset == 0">start</button>
          <button class="font-bold px-4 py-2 rounded border border-gray mx-4 my-2" type="button" @click="stop()" :disabled="started_at == 0">stop</button>
          <button class="font-bold px-4 py-2 rounded border border-gray mx-4 my-2" type="button" @click="reset()">reset</button>    
        </div>
        <div class="text-center my-4" style="font-size: 10rem">{{mmss}}</div>
      </div>
      <div v-if="!session">
        <div class="text-center my-4">
            <p>No session found.</p>
            <button class="font-bold px-4 py-2 rounded border border-gray mx-4 my-2" type="button" @click="newSession()">create new session</button>
        </div>
      </div>
      <div>
        <div v-for="(mob, index) in mobs" class="mb-2">
          <div class="px-2 py-2 relative w-1/4">
            {{mob}}
            <div class="absolute pin-t pin-r">
              <button class="px-2 py-2 border border-gray" @click="swapMob(index, index - 1)">↑</button>
              <button class="px-2 py-2 border border-gray" @click="swapMob(index, index + 1)">↓</button>
              <button class="px-2 py-2 border border-gray" @click="removeMob(mob)">x</button>    
            </div>
          </div>
        </div>
        <div>
          <input type="text" class="px-2 py-2 rounded border border-gray" v-model.trim="mobName" />
          <button class="font-bold px-4 py-2 rounded border border-gray" type="button" @click="addMob()">add mob</button>    
        </div>
      </div>
      <pre>{{ $data }}</pre>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        new Vue({
          el: '#app',
          data: {
            started_at: 0,
            sec_past: 0,
            offset: 0,
            mobs: [],
            mobName: '',
            session: ''
          },
          methods: {
            newSession() {
              this.collectionRef.add({
                created_at: Date.now(),
                started_at: 0,
                offset: 10
              })
              .then((docRef) => {
                location.hash = docRef.id
              })
              .catch((error) => {
                throw error
              })
            },
            reset() {
              this.sessionRef.set({
                started_at: 0,
                offset: 10
              }, { merge: true })
              this.sec_past = 0
            },
            start() {
              this.sessionRef.set({
                started_at: Date.now()
              }, { merge: true })
            },
            stop() {
              this.sessionRef.set({
                started_at: 0,
                offset: this.offset - this.sec_past
              }, { merge: true })
              this.sec_past = 0
            },
            addMob() {
              this.sessionRef.set({
                mobs: [...this.mobs, this.mobName]
              }, { merge: true })
              this.mobName = ''
            },
            swapMob(ia, ib) {
              ib = ib == 0 ? this.mobs.length - 1 : ib
              ib = ib == this.mobs.length ? 0 : ib
              let a = this.mobs[ia],
                  b = this.mobs[ib]

              this.mobs[ia] = b
              this.mobs[ib] = a              
              this.sessionRef.set({
                mobs: this.mobs
              }, { merge: true })

            },
            removeMob(mob) {
              this.sessionRef.set({
                mobs: this.mobs.filter(el => el != mob)
              }, { merge: true })
            }
          },
          computed: {
            mmss() { return this.mm + ':' + this.ss },
            mm() { return ('0' + (((this.offset - this.sec_past) / 60) | 0)).slice(-2) },
            ss() { return ('0' + (((this.offset - this.sec_past) % 60) | 0)).slice(-2) }
          },
          watch: {
            mmss(val) {
              document.title = val
            }
          },
          created: function () {
            let app = firebase.app()
            let db = app.firestore()
            this.collectionRef = db.collection('sessions')
            setInterval(() => {
              if (this.started_at == 0) {
                return
              }
              const s = (Date.now() - this.started_at) / 1000
              if (this.offset > s) {
                this.sec_past = s
              } else {
                this.sec_past = this.offset
                this.stop()
                new Notification('finish')
              }
            }, 100)

            onHashChange = (ev) => {
              let val = location.hash
              if (!val) {
                return
              }
              // remove '#'
              val = val.slice(1)
              this.sessionRef = this.collectionRef.doc(val)
              this.sessionRef.onSnapshot((snapShot) => {
                if (snapShot.exists) {
                  this.started_at = snapShot.data().started_at
                  this.offset = snapShot.data().offset
                  this.mobs = snapShot.data().mobs || []
                  this.session = val
                }
              })
            }
            window.onhashchange = onHashChange
            onHashChange()

            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
              Notification.requestPermission()
            }
          }
        })
      })
    </script>
  </body>
</html>
