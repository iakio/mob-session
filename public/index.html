<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css" rel="stylesheet">
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/5.10.1/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/5.10.1/firebase-firestore.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    <script defer src="https://unpkg.com/vue/dist/vue.js"></script>
  </head>
  <body>
    <div id="app">
      <div v-if="session">
        <div class="text-center">
          <button class="font-bold px-4 py-2 rounded border border-gray mx-4 my-2" type="button" @click="start()" :disabled="started_at != 0 || offset == 0">start</button>
          <button class="font-bold px-4 py-2 rounded border border-gray mx-4 my-2" type="button" @click="stop()" :disabled="started_at == 0">stop</button>
          <button class="font-bold px-4 py-2 rounded border border-gray mx-4 my-2" type="button" @click="reset()">reset</button>    
        </div>
        <div class="text-center my-4" style="font-size: 10rem">{{mmss}}</div>
      </div>
      <div v-if="!session">
        <div class="text-center my-4">
            <p>No session found.</p>
            <button class="font-bold px-4 py-2 rounded border border-gray mx-4 my-2" type="button" @click="newSession()">create new session</button>
        </div>
      </div>
      <pre>{{ $data | json }}</pre>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        let db
        new Vue({
          el: '#app',
          data: {
            started_at: 0,
            sec_past: 0,
            offset: 0,
            session: ''
          },
          methods: {
            newSession() {
              db.collection('sessions').add({
                created_at: Date.now(),
                started_at: 0,
                offset: 10
              })
              .then((docRef) => {
                location.hash = docRef.id
              })
              .catch((error) => {
                throw error
              })
            },
            reset() {
              db.collection('sessions').doc(this.session).set({
                started_at: 0,
                offset: 10
              })
              this.sec_past = 0
            },
            start() {
              db.collection('sessions').doc(this.session).set({
                started_at: Date.now()
              }, { merge: true })
            },
            stop() {
              db.collection('sessions').doc(this.session).set({
                started_at: 0,
                offset: this.offset - this.sec_past
              })
              this.sec_past = 0
            }
          },
          computed: {
            mmss() { return this.mm + ':' + this.ss },
            mm() { return ('0' + (((this.offset - this.sec_past) / 60) | 0)).slice(-2) },
            ss() { return ('0' + (((this.offset - this.sec_past) % 60) | 0)).slice(-2) }
          },
          watch: {
            mmss(val) {
              document.title = val
            }
          },
          created: function () {
            let app = firebase.app();
            db = app.firestore()
            setInterval(() => {
              if (this.started_at == 0) {
                return
              }
              const s = (Date.now() - this.started_at) / 1000
              if (this.offset > s) {
                this.sec_past = s
              } else {
                this.sec_past = this.offset
                this.stop()
                new Notification('finish')
              }
            }, 100)

            onHashChange = (ev) => {
              let val = location.hash
              if (!val) {
                return
              }
              // remove '#'
              val = val.slice(1)
              db.collection('sessions').doc(val).onSnapshot((snapShot) => {
                if (snapShot.exists) {
                  this.started_at = snapShot.data().started_at
                  this.offset = snapShot.data().offset
                  this.session = val
                }
              })
            }
            window.onhashchange = onHashChange
            onHashChange()

            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
              Notification.requestPermission()
            }
          }
        })
      })
    </script>
  </body>
</html>
